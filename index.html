<script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
<script src="https://rawgit.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>   

<script>

  window.addEventListener('load', ()=>{ 
    console.log('loaded!')

    var predioAsset = document.querySelector('#predio');
    predioAsset.addEventListener('progress', xhr => {
      console.log('predio asset:', xhr.detail.loadedBytes / xhr.detail.totalBytes * 100)
    })
    
  });

  function slowFade(entity, duration, inverse=false) {
    var opacity = 1
    var routine = setInterval(function(){
      var step = .02
      opacity = Math.round(((opacity - step) + Number.EPSILON) * 100) / 100
      entity.setAttribute('model-opacity',opacity)
      if (opacity <= 0){
        entity.object3D.visible = false;
        clearInterval(routine);
      }
    }, duration)
  }

  AFRAME.registerComponent('model-opacity', {
    schema: {default: 1.0},
    init: function () {
      this.el.addEventListener('model-loaded', this.update.bind(this));
    },
    update: function () {
      var mesh = this.el.getObject3D('mesh');
      var data = this.data;
      if (!mesh) { return; }
      mesh.traverse(function (node) {
        if (node.isMesh) {
          node.material.opacity = data;
          node.material.transparent = true;
          node.material.needsUpdate = true;
        }      
      });
    }
  });

  AFRAME.registerComponent('button', {
    init: function() {
      const button = document.querySelector('#buttonEntity');
      const predio = document.querySelector('#predioEntity')
      button.addEventListener('click', function(ev, target){
        console.log("clicked!");
        predio.emit('predio_rotate')
        slowFade(predio, 25)
      });
    }
  });

</script>

<body style="margin : 0px; overflow: hidden;">
    <a-scene 
      embedded
      id="scene"
      vr-mode-ui="enabled: false;"
      renderer="logarithmicDepthBuffer: true;
                antialias: true;
                colorManagement: true;
                sortObjects: true;
                physicallyCorrectLights: true;
                maxCanvasWidth: 1920;
                maxCanvasHeight: 1920;
                precision: low"
      arjs="trackingMethod: best;
            sourceType: webcam;
            debugUIEnabled: false;" 
    >
      <a-assets>
          <a-asset-item 
            id="button" 
            src="/res/button/box.gltf"
          />
          <a-asset-item
            id="predio"
            src="/res/inatelpredio/predionew.glb"
          />
      </a-assets>
      <a-marker 
        button
        id="marker" 
        preset="hiro" 
        emitevents="true"
      > 
        <a-entity 
          cursor="rayOrigin: mouse"
          raycaster="objects: .clickable; useWorldCoordinates: true;"
        ></a-entity> 

        <a-entity 
          material="visible: false"
          position="1 0.5 -0.5"
          light="
            type: point;
            intensity: 3;
            distance: 5;
            decay: 1"
        ></a-entity>

        <a-entity 
          class="clickable" 
          id ="buttonEntity" 
          gltf-model = "#button" 
          position = "1 0 .5" 
          scale = "0.2 0.1 0.2"
        ></a-entity> 

        <a-entity 
          id="predioEntity" 
          gltf-model="#predio" 
          position="0 0 .3" 
          rotation="0 -90 90" 
          scale=".2 .2 .2"
          animation="
            property: rotation; 
            from: 0 -90 90;
            to: 360 -90 90; 
            dur: 3000;
            loop: false;
            elasticity: 400;
            easing: easeInOutQuad;
            startEvents: predio_rotate;
          "
        ></a-entity>

      </a-marker>
      <a-entity camera></a-entity>
    </a-scene>
</body>
