<script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

<style>
  .arjs-loader {
    height: 100%;
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .arjs-loader div {
    text-align: center;
    font-size: 1.25em;
    color: white;
  }
</style>

<script>

  function slowFade(entity, duration, inverse=false) {
    var opacity = 1
    var routine = setInterval(function(){
      var step = .02
      opacity = Math.round(((opacity - step) + Number.EPSILON) * 100) / 100
      entity.setAttribute('model-opacity',opacity)
      if (opacity <= 0){
        predio.object3D.visible = false;
        clearInterval(routine);
      }
    }, duration)
  }

  window.addEventListener('load', ()=>{

    var predio = document.querySelector('#predio')

    predio.setAttribute('animation', `
      property: rotation; 
      from: 0 -90 90;
      to: 360 -90 90; 
      dur: 3000;
      loop: false;
      elasticity: 400;
      easing: easeInOutQuad;
      startEvents: predio_rotate;
    `)

    console.log(predio)
    
    setTimeout(() => {
      console.log('Event STARTED!!!!!!!!!!!!!!!!!!')
      predio.emit('predio_rotate')
      slowFade(predio, 10)
    }, 15000);

    AFRAME.registerComponent("clickhandler", {
        init: function() {
          this.el.addEventListener("click", () => {
            console.log('clicked');
          });
        }
      });

    AFRAME.registerComponent('model-opacity', {
      schema: {default: 1.0},
      init: function () {
        this.el.addEventListener('model-loaded', this.update.bind(this));
      },
      update: function () {
        var mesh = this.el.getObject3D('mesh');
        var data = this.data;
        if (!mesh) { return; }
        mesh.traverse(function (node) {
          if (node.isMesh) {
            node.material.opacity = data;
            node.material.transparent = true;
            node.material.needsUpdate = true;
          }      
        });
      }
    });
  })
</script>

<body style="margin : 0px; overflow: hidden;">

  <div class="arjs-loader">
    <div>Loading, please wait...</div>
  </div>

  <!-- Scene starts HERE -->
  <a-scene
    vr-mode-ui="enabled: false;"
    renderer="logarithmicDepthBuffer: true;
              antialias: true;
              colorManagement: true;
              sortObjects: true;
              physicallyCorrectLights: true;
              maxCanvasWidth: 1920;
              maxCanvasHeight: 1920;
              precision: low"
    embedded
    arjs="trackingMethod: best;
          sourceType: webcam;
          debugUIEnabled: false;" 
    cursor="rayOrigin: mouse; fuse: false; fuseTimeout: 0;"
    raycaster="objects: [clickhandler]; showLine: true"
    line="color: orange; opacity: 0.5"
  >
    <!-- Target Image -->
    <a-nft
      type="nft"
      url="/res/inateltarget/predio"
      smooth="true"
      smoothCount="40"
      smoothTolerance=".01"
      smoothThreshold="5"
      > 
        <!-- Ambient Light -->
        <a-box
          ambient-light
          material="visible: false"
          position="260 500 -200"
          light="type: point; intensity: 300; distance: 500; decay: 1"
        >
        </a-box>

        <!-- Predio Model -->
        <a-entity
          id="predio"
          gltf-model="/res/inatelpredio/predionew.glb"
          scale="15 15 15"
          position="150 220 -40"
          rotation="0 -90 90"
        >
        </a-entity>

        <!-- Red Virtual Button -->
        <a-box
          clickhandler
          material="
            color: red;
          "
          scale="30 5 30"
          position="300 220 -40"
        >
        </a-box>
       
    </a-nft>
    <a-entity 
      camera
    />
  </a-scene>

</body>